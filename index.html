<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --surface: #ffffff;
      --surface-2:#f8f9fb;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    html, body { height: 100%; background: var(--surface-2); color: var(--text); }
    .center-wrap { min-height: 100vh; display:grid; place-items:center; }
    .card-white {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15,23,42,.06);
      border-radius: 1rem;
    }
    .brand { font-weight:700; letter-spacing:.3px; }
    .timer-badge { font-variant-numeric: tabular-nums; font-weight:700; letter-spacing:.5px; }
    .muted { color: var(--muted); }
    #formFrame { width:100%; height:calc(100vh - 4.25rem); border:none; background:var(--surface); display:block; margin:0 auto; max-width:900px; }
    .navbar-white {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>
<body>

  <!-- ====== TELA DE LOGIN ====== -->
  <section id="loginView" class="center-wrap">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card card-white p-4">
            <div class="text-center mb-3">
              <div class="brand fs-4">Portal de Avaliações - HyperClass</div>
              <small class="muted">Acesse com sua conta Google @senaimgaluno.com.br</small>
            </div>

            <!-- Aviso leve -->
            <div class="alert alert-light border" role="alert">
              <strong>Observação:</strong> você deve fazer login para dar início a avaliação.
            </div>

            <!-- Botão Google Sign-In -->
            <div id="g_id_onload"
                 data-client_id="665771246445-7jm7ikg7env33c6in5pvtk05edmg8rob.apps.googleusercontent.com"
                 data-auto_prompt="false"
                 data-callback="handleCredentialResponse">
            </div>
            <div class="d-flex justify-content-center">
              <div class="g_id_signin"
                   data-type="standard"
                   data-size="large"
                   data-theme="outline"
                   data-text="signin_with"
                   data-shape="rectangular"
                   data-logo_alignment="left">
              </div>
            </div>

            <div id="loginMsg" class="text-danger mt-3" style="display:none;"></div>

            <div class="mt-4 text-center">
              <small class="muted">Ao continuar, você concorda com os termos do teste.</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====== (A PARTIR DAQUI ERA O FLUXO DO TESTE) ====== -->
  <!-- Mantido apenas se você ainda precisar; não será exibido porque haverá redirecionamento para home.html após login -->

  <nav id="topbar" class="navbar navbar-white fixed-top d-none">
    <div class="container-fluid justify-content-center">
      <span class="navbar-text">
        Tempo restante:
        <span id="timer" class="badge bg-secondary text-light timer-badge">02:00:00</span>
      </span>
      <span id="userInfo" class="navbar-text ms-3" style="font-size:0.9rem;"></span>
    </div>
  </nav>

  <section id="intro" class="center-wrap d-none">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card card-white p-4">
            <h1 class="mb-3">Instruções para realização do teste</h1>
            <div class="text-start p-4 rounded-3 border">
              <ol class="mb-0">
                <li>Ao clicar em <strong>Começar</strong>, o teste entrará em <strong>tela cheia</strong> e o cronômetro de <strong>2 horas</strong> será iniciado.</li>
                <li>Não feche a aba durante a execução do teste. O tempo continuará contando.</li>
                <li>Responda a todas as questões no formulário exibido.</li>
                <li>Ao término do tempo, finalize e envie suas respostas.</li>
              </ol>
            </div>
            <div class="d-grid mt-4">
              <button id="startBtn" class="btn btn-dark btn-lg">Começar</button>
            </div>
            <p class="muted mt-3 mb-0">Dica: mantenha sua conexão estável durante todo o teste.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main id="exam" class="d-none">
    <div class="container-fluid">
      <iframe
        id="formFrame"
        src="https://docs.google.com/forms/d/e/1FAIpQLSckVn12oUJo-kuoow3bE-E8zeZ03zUVUaN2QziQUweHwPnwlg/viewform?embedded=true"
        allowfullscreen
      >Carregando…</iframe>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== Helpers =====
    function parseJwt (token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function show(el){ el.classList.remove('d-none'); }
    function hide(el){ el.classList.add('d-none'); }
    function pad(n){ return String(n).padStart(2, '0'); }
    function formatTime(msLeft){
      const totalSec = Math.max(0, Math.floor(msLeft/1000));
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = totalSec%60;
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // ===== Estado global =====
    const loginView = document.getElementById('loginView');
    const intro = document.getElementById('intro');
    const exam = document.getElementById('exam');
    const topbar = document.getElementById('topbar');
    const timerEl = document.getElementById('timer');
    const userInfo = document.getElementById('userInfo');
    const startBtn = document.getElementById('startBtn');
    const loginMsg = document.getElementById('loginMsg');

    let ticking = false;
    let intervalId = null;
    const DURATION_MS = 2 * 60 * 60 * 1000; // 2h

    // ===== Login callback (Google Identity Services) =====
    window.handleCredentialResponse = (response) => {
      try {
        const payload = parseJwt(response.credential);
        const email = payload.email;
        const name = payload.name || '';

        if (!email) {
          loginMsg.style.display = 'block';
          loginMsg.textContent = 'Não foi possível obter o e-mail da conta Google.';
          return;
        }

        // Guardar sessão simples no localStorage
        localStorage.setItem('examUser', JSON.stringify({ email, name }));

        // Redireciona para a home após login com QUALQUER conta Google
        window.location.href = 'home.html';

      } catch (e) {
        console.error(e);
        loginMsg.style.display = 'block';
        loginMsg.textContent = 'Falha ao processar login. Tente novamente.';
      }
    };

    // Se já estiver logado, vai direto para a home
    (function restoreSession(){
      const raw = localStorage.getItem('examUser');
      if (!raw) return;
      try {
        const u = JSON.parse(raw);
        if (u && u.email) {
          window.location.href = 'home.html';
        }
      } catch {}
    })();

    // ===== Fluxo do teste (mantido, mas não usado quando há redirecionamento) =====
    function startTimer() {
      const endAt = Date.now() + DURATION_MS;
      timerEl.textContent = formatTime(DURATION_MS);

      intervalId = setInterval(() => {
        const left = endAt - Date.now();
        timerEl.textContent = formatTime(left);

        if (left <= 5 * 60 * 1000 && !timerEl.classList.contains('bg-danger')) {
          timerEl.classList.remove('bg-secondary','text-light');
          timerEl.classList.add('bg-danger','text-light');
        }
        if (left <= 0) {
          clearInterval(intervalId);
          timerEl.textContent = '00:00:00';
          alert('Tempo encerrado! Envie suas respostas agora.');
        }
      }, 1000);
    }

    async function goFullscreen() {
      const el = document.documentElement;
      try {
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) await el.msRequestFullscreen();
      } catch (e) {
        console.warn('Não foi possível ativar tela cheia:', e);
      }
    }

    if (startBtn) {
      startBtn.addEventListener('click', async () => {
        if (ticking) return;
        ticking = true;

        await goFullscreen();
        startTimer();
        show(topbar);

        hide(intro);
        show(exam);

        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    function adjustIframeHeight() {
      const navH = document.querySelector('.navbar.fixed-top')?.offsetHeight || 0;
      const frame = document.getElementById('formFrame');
      if (frame) frame.style.height = `calc(100vh - ${navH}px)`;
    }
    window.addEventListener('resize', adjustIframeHeight);
    window.addEventListener('load', adjustIframeHeight);
  </script>
</body>
</html>
